---
// src/pages/posts/index.astro

import BaseLayout from "../../layouts/BaseLayout.astro";
import { client, getImageUrl, formatDate } from "../../../sanity/client"; // formatDate 추가
import Adsense from "../../components/Adsense.astro"; // Adsense 컴포넌트 추가

// 모든 post를 최신순으로 가져오는 쿼리 (생성일도 함께 가져오기)
const query = `*[_type == "post"] | order(publishedAt desc) {
  title,
  "slug": slug.current,
  publishedAt,
  excerpt,
  mainImage {
    asset->{
        _id,
        url
    },
    alt
  }
}`;

const posts: any[] = await client.fetch(query);

// 디버깅을 위한 로그 - excerpt 내용 확인
console.log(
  "Posts excerpts:",
  posts?.map((post: any) => ({
    title: post.title,
    excerpt: post.excerpt,
    excerptLength: post.excerpt?.length || 0,
    isEmptyExcerpt: !post.excerpt || post.excerpt.trim().length === 0,
  })),
);

// 디버깅을 위한 로그
console.log(
  "Posts with dates:",
  posts?.map((post: any) => ({
    title: post.title,
    publishedAt: post.publishedAt,
    _createdAt: post._createdAt,
  })),
);

if (!posts) {
  // return new Response(null, {
  //   status: 404,
  //   statusText: 'Not found'
  // });
}
---

<BaseLayout
  title="All Posts"
  description="A list of all the articles and posts on my blog."
>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-8">
      All Posts
    </h1>
    <div class="grid gap-8">
      {
        posts.map((post: any, index: number) => (
          <>
            <article class="bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
              <div class="p-6 sm:p-8">
                <h3 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2 transition-colors">
                  <a href={`/posts/${post.slug}`} class="hover:underline">
                    {post.title}
                  </a>
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                  Published on {formatDate(post.publishedAt)}
                </p>
                <p class="text-gray-600 dark:text-gray-300 text-base leading-relaxed mb-4">
                  {post.excerpt}
                </p>
                <a
                  class="inline-flex items-center text-base font-medium text-[#3d98f4] hover:text-blue-700 transition-colors group"
                  href={`/posts/${post.slug}`}
                >
                  Read More
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="ml-1 group-hover:translate-x-1 transition-transform duration-200"
                  >
                    <path d="M5 12h14M12 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </article>

            {/* 3번째 게시글 뒤에 디스플레이 광고 삽입 */}
            {import.meta.env.PROD && (index + 1) % 3 === 0 && (
              <div class="my-6 bg-white dark:bg-gray-800 rounded-xl p-4 flex justify-center ad-wrapper">
                <Adsense slot="6928041788" />
              </div>
            )}
          </>
        ))
      }
    </div>
  </div>
</BaseLayout>
