---
// src/pages/posts/[...slug].astro

import { toHTML } from '@portabletext/to-html';
import { client, formatDate, getImageUrl } from '../../../sanity/client'; // 새로운 이미지 함수 추가
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';

// --- Astro의 동적 페이지 생성 기능 ---
// 1. 어떤 페이지들을 만들어야 하는지 목록을 생성합니다.
export async function getStaticPaths() {
  const query = `*[_type == "post" && defined(slug.current)][] { "slug": slug.current }`;
  const posts = await client.fetch(query);
  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

// 2. 현재 페이지의 slug 값을 가져옵니다.
const { slug } = Astro.params;

// --- 데이터 가져오기 ---
// 3. 해당 slug를 가진 포스트의 모든 데이터를 가져옵니다.
const query = `*[_type == "post" && slug.current == $slug][0] {
  title,
  publishedAt,
  "mainImage": mainImage {
    asset->{
      _id,
      url,
      "dimensions": metadata.dimensions
    },
    alt
  },
  body,
  excerpt,
  "category": categories[0]->title
}`;

const post = await client.fetch(query, { slug });

// 데이터가 없으면 404 페이지를 보여줍니다.
if (!post) {
  return Astro.redirect('/404');
}

// 1. Slugify 함수 및 headings 배열 추가
const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
const headings: {level: number, text: string, slug: string}[] = [];

// Helper function to convert portable text spans to plain text
const toPlainText = (blocks: any[] = []) => {
    return blocks
        .map(block => {
            if (block._type === 'span' && block.text) {
                return block.text;
            }
            return '';
        })
        .join('');
};

// --- Sanity 데이터 처리 ---
// 쿠키 없는 이미지 URL 생성 함수 사용

// 본문(Portable Text)을 HTML로 변환합니다.
const bodyHtml = toHTML(post.body || [], {
  components: {
    block: {
      // 2. Heading 컴포넌트 수정 (ID 추가 및 headings 배열에 push)
      h1: ({children}: any) => `<h1 class="text-3xl font-bold text-slate-900 dark:text-white mt-8 mb-4">${children}</h1>`,
      h2: ({children, value}: any) => {
        const text = toPlainText(value.children);
        const slug = slugify(text);
        headings.push({ level: 2, text: text, slug });
        return `<h2 id="${slug}" class="mt-6 mb-3 border-l-4 border-[#3d98f4] pl-4 text-2xl font-semibold text-slate-800 dark:text-gray-200">${children}</h2>`;
      },
      h3: ({children, value}: any) => {
        const text = toPlainText(value.children);
        const slug = slugify(text);
        headings.push({ level: 3, text: text, slug });
        return `<h3 id="${slug}" class="mt-5 mb-2 border-l-2 border-gray-300 dark:border-gray-600 pl-3 text-xl font-semibold text-slate-800 dark:text-gray-300">${children}</h3>`;
      },
      h4: ({children}: any) => `<h4 class="text-lg font-medium text-slate-800 dark:text-gray-300 mt-4 mb-2">${children}</h4>`,
      // 일반 텍스트 블록
      normal: ({children}: any) => `<p class="mb-6 leading-loose text-base sm:text-lg">${children}</p>`,
    },
    list: {
      // 불릿 포인트 리스트
      bullet: ({children}: any) => `<ul class="list-disc list-inside mb-6 space-y-1 ml-4 text-base sm:text-lg">${children}</ul>`,
      // 번호 리스트
      number: ({children}: any) => `<ol class="list-decimal list-inside mb-6 space-y-1 ml-4 text-base sm:text-lg">${children}</ol>`,
    },
    listItem: {
      // 리스트 아이템
      bullet: ({children}: any) => `<li class="leading-loose">${children}</li>`,
      number: ({children}: any) => `<li class="leading-loose">${children}</li>`,
    },
    marks: {
      // 강조 텍스트
      strong: ({children}: any) => `<strong class="font-semibold">${children}</strong>`,
      em: ({children}: any) => `<em class="italic">${children}</em>`,
      // 링크
      link: ({children, value}: any) => `<a href="${value.href}" class="text-[#3d98f4] hover:underline" target="_blank" rel="noopener noreferrer">${children}</a>`,
    },
    types: {
      // 이미지 렌더링 (쿠키 없는 방식)
      image: ({value}: any) => {
        if (!value || !value.asset) return '';
        
        const imageUrl = getImageUrl(value.asset, { width: 800 });
        const alt = value.alt || 'Image';
        const caption = value.caption;
        
        return `
          <figure class="my-8">
            <img 
              src="${imageUrl}" 
              alt="${alt}" 
              class="w-full h-auto rounded-lg shadow-md"
              loading="lazy"
            />
            ${caption ? `<figcaption class="text-center text-sm text-gray-600 mt-2 italic">${caption}</figcaption>` : 
              (value.alt ? `<figcaption class="text-center text-sm text-gray-600 mt-2 italic">${value.alt}</figcaption>` : '')}
          </figure>
        `;
      },
      // 표 렌더링
      table: ({value}: any) => {
        const {rows} = value;
        if (!rows || rows.length === 0) return '';
        
        const headerRow = rows[0];
        const bodyRows = rows.slice(1);
        
        return `
          <div class="overflow-x-auto my-6">
            <table class="min-w-full border-collapse border border-gray-300 dark:border-gray-600">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  ${headerRow.cells.map((cell: any) => 
                    `<th class="whitespace-nowrap border border-gray-300 dark:border-gray-600 px-4 py-2 text-left font-semibold text-gray-900 dark:text-gray-100">${cell || ''}</th>`
                  ).join('')}
                </tr>
              </thead>
              <tbody>
                ${bodyRows.map((row: any) => `
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    ${row.cells.map((cell: any) => 
                      `<td class="whitespace-nowrap border border-gray-300 dark:border-gray-600 px-4 py-2 text-gray-700 dark:text-gray-300">${cell || ''}</td>`
                    ).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    }
  }
});
---

<BaseLayout title={post.title} description={post.excerpt}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <article class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
      <div class="p-6 sm:p-8 lg:p-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white mb-4">{post.title}</h1>
        <div class="flex items-center text-base text-gray-500 dark:text-gray-400 mb-8">
          <span>Published on {new Date(post.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          {post.category && (
            <>
              <span class="mx-2">·</span>
              <span>{post.category}</span>
            </>
          )}
        </div>

        {post.mainImage && post.mainImage.asset && (
          <div class="my-8">
            <Image
              class="w-full h-auto rounded-lg shadow-md"
              src={post.mainImage.asset.url}
              width={post.mainImage.asset.dimensions.width}
              height={post.mainImage.asset.dimensions.height}
              format="webp"
              alt={post.mainImage.alt || post.title}
              loading="eager"
              fetchpriority="high"
            />
          </div>
        )}
        
        <!-- 3. 목차(TOC) 컴포넌트 추가 -->
        {headings.length > 0 && (
          <div class="mb-8 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-700">
            <h2 class="text-xl font-bold mb-3 dark:text-white">On this page</h2>
            <ul class="space-y-2">
              {headings.map((heading) => (
                <li class:list={[
                  'font-medium',
                  { 'ml-4': heading.level === 3 }
                ]}>
                  <a 
                    href={`#${heading.slug}`} 
                    class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition-colors"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}

        <div class="prose prose-lg max-w-none dark:prose-invert" set:html={bodyHtml} />
      </div>
    </article>
  </div>
</BaseLayout> 