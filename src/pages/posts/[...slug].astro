---
// src/pages/posts/[...slug].astro

import { toHTML } from '@portabletext/to-html';
import imageUrlBuilder from '@sanity/image-url';
import { client, formatDate } from '../../../sanity/client'; // client와 formatDate 둘 다 불러오기
import BaseLayout from '../../layouts/BaseLayout.astro';

// --- Astro의 동적 페이지 생성 기능 ---
// 1. 어떤 페이지들을 만들어야 하는지 목록을 생성합니다.
export async function getStaticPaths() {
  const query = `*[_type == "post" && defined(slug.current)][] { "slug": slug.current }`;
  const posts = await client.fetch(query);
  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

// 2. 현재 페이지의 slug 값을 가져옵니다.
const { slug } = Astro.params;

// --- 데이터 가져오기 ---
// 3. 해당 slug를 가진 포스트의 모든 데이터를 가져옵니다.
const query = `*[_type == "post" && slug.current == $slug][0] {
  title,
  publishedAt,
  _createdAt,
  mainImage,
  body,
  "category": categories[0]->title // 첫 번째 카테고리의 제목만 가져옵니다.
}`;

const post = await client.fetch(query, { slug });

// 데이터가 없으면 404 페이지를 보여줍니다.
if (!post) {
  return Astro.redirect('/404');
}

// --- Sanity 데이터 처리 ---
// Sanity 이미지 URL을 만들어주는 헬퍼 함수
const builder = imageUrlBuilder(client);
function urlFor(source: any) {
  return builder.image(source);
}

// 본문(Portable Text)을 HTML로 변환합니다.
const bodyHtml = toHTML(post.body || [], {
  components: {
    block: {
      // 헤딩 스타일 정의
      h1: ({children}: any) => `<h1 class="text-3xl font-bold text-slate-900 mt-8 mb-4">${children}</h1>`,
      h2: ({children}: any) => `<h2 class="text-2xl font-semibold text-slate-800 mt-6 mb-3">${children}</h2>`,
      h3: ({children}: any) => `<h3 class="text-xl font-semibold text-slate-800 mt-5 mb-2">${children}</h3>`,
      h4: ({children}: any) => `<h4 class="text-lg font-medium text-slate-800 mt-4 mb-2">${children}</h4>`,
      // 일반 텍스트 블록
      normal: ({children}: any) => `<p class="mb-6 leading-loose text-base sm:text-lg">${children}</p>`,
    },
    list: {
      // 불릿 포인트 리스트
      bullet: ({children}: any) => `<ul class="list-disc list-inside mb-6 space-y-1 ml-4 text-base sm:text-lg">${children}</ul>`,
      // 번호 리스트
      number: ({children}: any) => `<ol class="list-decimal list-inside mb-6 space-y-1 ml-4 text-base sm:text-lg">${children}</ol>`,
    },
    listItem: {
      // 리스트 아이템
      bullet: ({children}: any) => `<li class="leading-loose">${children}</li>`,
      number: ({children}: any) => `<li class="leading-loose">${children}</li>`,
    },
    marks: {
      // 강조 텍스트
      strong: ({children}: any) => `<strong class="font-semibold">${children}</strong>`,
      em: ({children}: any) => `<em class="italic">${children}</em>`,
      // 링크
      link: ({children, value}: any) => `<a href="${value.href}" class="text-[#3d98f4] hover:underline" target="_blank" rel="noopener noreferrer">${children}</a>`,
    }
  }
});
---

<BaseLayout title={post.title}>
  <main class="px-4 sm:px-6 md:px-20 lg:px-40 flex flex-1 justify-center py-8 bg-slate-50">
    <div class="layout-content-container flex flex-col max-w-4xl flex-1">
      <!-- 브레드크럼 네비게이션 -->
      <div class="flex flex-wrap gap-2 p-4 text-sm">
        <a class="text-slate-500 hover:text-[#3d98f4] font-medium transition-colors" href="/">Home</a>
        <span class="text-slate-400 font-medium">/</span>
        <a class="text-slate-500 hover:text-[#3d98f4] font-medium transition-colors" href="/posts">Posts</a>
        <span class="text-slate-400 font-medium">/</span>
        <span class="text-slate-800 font-medium">Article</span>
      </div>
      
      <article class="bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- 대표 이미지 표시 -->
        {post.mainImage && (
          <img
            class="w-full h-auto object-cover max-h-96"
            src={urlFor(post.mainImage).width(800).url()}
            alt={post.title}
          />
        )}
        <div class="p-6 md:p-10">
          <!-- 포스트 헤더 정보 -->
          <h1 class="text-slate-900 text-3xl md:text-4xl font-bold leading-tight tracking-tight mb-4">
            {post.title}
          </h1>
          <div class="flex items-center text-slate-500 text-sm mb-6">
            <span>Published on {formatDate(post.publishedAt || post._createdAt)}</span>
            {post.category && (
              <>
                <span class="mx-2">·</span>
                <a href="#" class="hover:text-[#3d98f4] transition-colors">
                  Category: {post.category}
                </a>
              </>
            )}
          </div>

          <!-- 포스트 본문 -->
          <div class="prose prose-lg prose-slate max-w-none text-slate-700 leading-loose" set:html={bodyHtml} />
        </div>
      </article>
      <!-- "Related Articles" 섹션은 나중에 추가하겠습니다. -->
    </div>
  </main>
</BaseLayout> 