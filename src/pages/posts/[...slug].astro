---
// src/pages/posts/[...slug].astro

import { toHTML } from '@portabletext/to-html';
import { client, formatDate, getImageUrl } from '../../../sanity/client'; // 새로운 이미지 함수 추가
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import { Fragment } from 'astro/jsx-runtime';
import Adsense from '../../components/Adsense.astro';

// --- Astro의 동적 페이지 생성 기능 ---
// 1. 어떤 페이지들을 만들어야 하는지 목록을 생성합니다.
export async function getStaticPaths() {
  const query = `*[_type == "post" && defined(slug.current)][] { "slug": slug.current }`;
  const posts = await client.fetch(query);
  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

// 2. 현재 페이지의 slug 값을 가져옵니다.
const { slug } = Astro.params;

// --- 데이터 가져오기 ---
// 3. 해당 slug를 가진 포스트의 모든 데이터를 가져옵니다.
const query = `*[_type == "post" && slug.current == $slug][0] {
  title,
  publishedAt,
  "mainImage": mainImage {
    asset->{
      _id,
      url,
      "dimensions": metadata.dimensions
    },
    alt
  },
  body,
  excerpt,
  "category": categories[0]->title
}`;

const post = await client.fetch(query, { slug });

// 데이터가 없으면 404 페이지를 보여줍니다.
if (!post) {
  return Astro.redirect('/404');
}

// excerpt가 없거나 공백일 경우 고유한 description 생성
const getUniqueDescription = (title: string, excerpt: string) => {
  // excerpt가 있고 공백이 아닌 경우
  if (excerpt && excerpt.trim().length > 0) {
    return excerpt.trim();
  }
  
  // excerpt가 없거나 공백인 경우 제목 기반으로 description 생성
  return `${title}에 대한 자세한 내용을 확인해보세요. 유용한 정보와 실용적인 팁을 제공합니다.`;
};

const description = getUniqueDescription(post.title, post.excerpt);

// 디버깅을 위한 로그
console.log('Post title:', post.title);
console.log('Original excerpt:', post.excerpt);
console.log('Final description:', description);

// 1. Slugify 함수 및 headings 배열, 카운터 추가
const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');

const headings: {level: number, text: string, slug: string, number: string}[] = [];
let h2Counter = 0;
let h3Counter = 0;

const generatedSlugs = new Set<string>();

const createUniqueSlug = (text: string) => {
  let slug = slugify(text);
  let uniqueSlug = slug;
  let counter = 2;
  while (generatedSlugs.has(uniqueSlug)) {
    uniqueSlug = `${slug}-${counter}`;
    counter++;
  }
  generatedSlugs.add(uniqueSlug);
  return uniqueSlug;
};

const toPlainText = (blocks: any[] = []) => {
    return blocks
        .map(block => {
            if (block._type === 'span' && block.text) {
                return block.text;
            }
            return '';
        })
        .join('');
};

// --- 본문 콘텐츠를 프롤로그와 섹션으로 그룹화하는 로직 ---
const sections: { title: string | null; id: string; content: string[] }[] = [];
// 첫 섹션을 미리 만들어 둠 (h2 이전의 프롤로그 콘텐츠용)
let currentSection: { title: string | null; id: string; content: string[] } = {
  title: null, 
  id: 'prologue',
  content: []
};

const components = {
  block: {
    h2: ({ children, value }: any) => {
      // h2를 만나면, 현재까지의 섹션(프롤로그 또는 이전 h2섹션)을 배열에 푸시합니다.
      sections.push(currentSection);

      // h2 정보로 새 섹션을 시작합니다.
      const text = toPlainText(value.children);
      const slug = createUniqueSlug(text);
      h2Counter++;
      h3Counter = 0;
      const number = `${h2Counter}.`;
      headings.push({ level: 2, text, slug, number });
      
      currentSection = {
        title: children, // HTML이 포함된 제목
        id: slug,
        content: []
      };
      
      return ''; // h2 자체는 렌더링하지 않습니다.
    },
    h3: ({ children, value }: any) => {
      h3Counter++;
      const text = toPlainText(value.children);
      const slug = createUniqueSlug(text);
      const number = '–'; // H3 기호를 대시로 변경
      headings.push({ level: 3, text, slug, number });

      // 본문 H3에서 왼쪽 구분선을 제거합니다.
      const h3Html = `<h3 id="${slug}" class="scroll-mt-24 mt-10 mb-4 text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100">${children}</h3>`;
      currentSection.content.push(h3Html);
      return '';
    },
    normal: ({ children }: any) => {
      currentSection.content.push(`<p class="mb-6 leading-loose text-slate-700 dark:text-slate-300 text-[17px] sm:text-lg">${children}</p>`);
      return '';
    },
    h1: ({children}: any) => {
      currentSection.content.push(`<h1 class="text-3xl font-bold text-slate-900 dark:text-white mt-8 mb-4">${children}</h1>`);
      return '';
    },
    h4: ({children}: any) => {
      currentSection.content.push(`<h4 class="text-lg font-medium text-slate-800 dark:text-gray-300 mt-4 mb-2">${children}</h4>`);
      return '';
    },
  },
  list: {
    bullet: ({ children }: any) => {
      currentSection.content.push(`<ul class="list-disc list-inside mb-6 space-y-2 ml-4 text-[17px] sm:text-lg text-slate-700 dark:text-slate-300">${children}</ul>`);
      return '';
    },
    number: ({ children }: any) => {
      currentSection.content.push(`<ol class="list-decimal list-inside mb-6 space-y-2 ml-4 text-[17px] sm:text-lg text-slate-700 dark:text-slate-300">${children}</ol>`);
      return '';
    },
  },
  listItem: {
    bullet: ({ children }: any) => `<li class="leading-loose">${children}</li>`,
    number: ({ children }: any) => `<li class="leading-loose">${children}</li>`,
  },
  marks: {
    strong: ({ children }: any) => `<strong class="font-semibold text-slate-800 dark:text-slate-200">${children}</strong>`,
    em: ({ children }: any) => `<em class="italic">${children}</em>`,
    link: ({ children, value }: any) => `<a href="${value.href}" class="text-slate-600 dark:text-slate-400 hover:underline hover:text-slate-800 dark:hover:text-slate-200" target="_blank" rel="noopener noreferrer">${children}</a>`,
  },
  types: {
    image: ({ value }: any) => {
      if (!value || !value.asset) return '';
      const imageUrl = getImageUrl(value.asset, { width: 800 });
      const alt = value.alt || 'Image';
      const caption = value.caption;
      const html = `
        <figure class="my-8">
          <img src="${imageUrl}" alt="${alt}" class="w-full h-auto rounded-lg shadow-md" loading="lazy" />
          ${caption ? `<figcaption class="text-center text-sm text-slate-600 dark:text-slate-400 mt-2 italic">${caption}</figcaption>` : 
            (value.alt ? `<figcaption class="text-center text-sm text-slate-600 dark:text-slate-400 mt-2 italic">${value.alt}</figcaption>` : '')}
        </figure>
      `;
      currentSection.content.push(html);
      return '';
    },
    table: ({ value }: any) => {
      const { rows } = value;
      if (!rows || rows.length === 0) return '';
      const headerRow = rows[0];
      const bodyRows = rows.slice(1);
      const html = `
        <div class="overflow-x-auto my-6 border border-slate-200 dark:border-slate-700 rounded-lg">
          <table class="min-w-full border-collapse">
            <thead class="bg-slate-50 dark:bg-slate-700/50">
              <tr>
                ${headerRow.cells.map((cell: any) => 
                  `<th class="whitespace-nowrap border-b border-slate-200 dark:border-slate-700 px-4 py-3 text-left font-semibold text-slate-800 dark:text-slate-200">${cell || ''}</th>`
                ).join('')}
              </tr>
            </thead>
            <tbody>
              ${bodyRows.map((row: any) => `
                <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/50">
                  ${row.cells.map((cell: any) => 
                    `<td class="whitespace-nowrap border-t border-slate-200 dark:border-slate-700 px-4 py-3 text-slate-600 dark:text-slate-300">${cell || ''}</td>`
                  ).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      currentSection.content.push(html);
      return '';
    }
  }
};

toHTML(post.body || [], { components });
sections.push(currentSection);

// 중간 광고 위치 계산 (두 번째 H2 섹션 후)
const adPosition = 2; // 두 번째 H2 섹션 후
let h2Count = 0;
const sectionsWithAd = sections.map((section, index) => {
  if (section.title && section.content.length > 0) {
    h2Count++;
  }
  return {
    ...section,
    showAdAfter: h2Count === adPosition
  };
});

---
<BaseLayout title={post.title} description={description}>
  <div class="max-w-5xl mx-auto px-2 sm:px-6 lg:px-8 py-12">
    <article class="bg-transparent">
      <div class="py-4 sm:p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white mb-4 leading-tight">{post.title}</h1>
        <div class="flex items-center text-base text-gray-500 dark:text-gray-400 mb-8">
          <span>Published on {new Date(post.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          {post.category && (
            <Fragment>
              <span class="mx-2">·</span>
              <span>{post.category}</span>
            </Fragment>
          )}
        </div>

        {post.mainImage && post.mainImage.asset && (
          <div class="my-8">
            <Image
              class="w-full max-h-[500px] object-cover rounded-lg shadow-md"
              src={post.mainImage.asset.url}
              width={post.mainImage.asset.dimensions.width}
              height={post.mainImage.asset.dimensions.height}
              format="webp"
              alt={post.mainImage.alt || post.title}
              loading="eager"
              fetchpriority="high"
            />
          </div>
        )}
        
        <!-- 3. 목차(TOC) 컴포넌트 수정 (넘버링 표시) -->
        {headings.length > 0 && (
          <div class="mb-12 p-6 bg-gray-50 dark:bg-gray-900/50 rounded-2xl border border-gray-200 dark:border-gray-700/50">
            <h2 class="text-xl font-bold mb-4 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-slate-500"><path d="M4 6h16M4 12h16M4 18h7"/></svg>On this page</h2>
            <ul class="space-y-2">
              {headings.map((heading) => (
                <li class:list={[
                  'font-medium',
                  { 'ml-4': heading.level === 3 } // H3 들여쓰기 조정
                ]}>
                  <a 
                    href={`#${heading.slug}`} 
                    class="toc-link flex items-start text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white transition-colors group"
                  >
                    <span 
                      class:list={[
                        "mr-2.5 text-gray-400 dark:text-gray-500 w-5 text-right shrink-0 group-hover:text-slate-500 dark:group-hover:text-slate-400 transition-colors",
                        heading.level === 2 ? 'font-mono' : 'text-center' // H2는 숫자 폰트, H3는 기호 중앙 정렬
                      ]}
                    >
                      {heading.number}
                    </span>
                    <span class="flex-1">{heading.text}</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}

        <!-- 본문 상단 광고 -->
        <div class="my-8 flex justify-center">
          <Adsense slot="2197969029" />
        </div>

        <div class="space-y-8">
          {sectionsWithAd.map((section, index) => {
            // 섹션에 내용이 없으면 렌더링하지 않습니다 (예: 글이 H2로 바로 시작하는 경우의 빈 프롤로그).
            if (section.content.length === 0) return null;
            
            return (
              <Fragment>
                <div class="p-px rounded-2xl bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-800 hover:shadow-xl hover:shadow-slate-400/30 dark:hover:shadow-black/30 transition-all duration-300">
                  <section 
                    id={section.id} 
                    class="scroll-mt-24 p-6 sm:p-8 rounded-[14px] bg-slate-50/90 dark:bg-slate-800/90 backdrop-blur-lg"
                  >
                    {section.title && (
                      <h2 
                        class="text-2xl sm:text-3xl font-extrabold text-slate-900 dark:text-white mb-8 tracking-tight flex items-start gap-3"
                        set:html={section.title}
                      />
                    )}
                    <div 
                      class="prose prose-lg max-w-none dark:prose-invert" 
                      set:html={section.content.join('')} 
                    />
                  </section>
                </div>
                
                {/* 두 번째 H2 섹션 후에 본문 중간 광고 삽입 */}
                {section.showAdAfter && (
                  <div class="my-8 flex justify-center">
                    <Adsense slot="5616138153" />
                  </div>
                )}
              </Fragment>
            )
          })}
        </div>

        <!-- 본문 하단 광고 -->
        <div class="my-8 flex justify-center">
          <Adsense slot="8899108740" />
        </div>
      </div>
    </article>
  </div>
</BaseLayout>
<style>
  .prose > :first-child {
    margin-top: 0;
  }
  .prose h3:first-child {
    margin-top: 0;
  }
  .prose h2, .prose h3, .prose h4 {
    /* set:html로 주입되는 콘텐츠 내부의 제목 스타일은 여기에 정의합니다. */
  }
</style>

<style is:global>
  body {
    background-color: #f8fafc; /* light mode fallback */
    background-image: linear-gradient(180deg, #f0f4ff 0%, #f8fafc 100%);
  }
  .dark body {
    background-color: #0b1120; /* dark mode fallback */
    background-image: linear-gradient(180deg, #0d1222 0%, #020617 100%);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 모든 목차 링크를 선택합니다.
    const tocLinks = document.querySelectorAll('.toc-link');

    // 링크가 없으면 아무 작업도 하지 않습니다.
    if (!tocLinks.length) return;

    // 각 링크에 클릭 이벤트 리스너를 추가합니다.
    tocLinks.forEach(link => {
      link.addEventListener('click', (event) => {
        // 링크의 기본 동작(페이지 이동 및 기록 추가)을 막습니다.
        event.preventDefault();

        // href 속성에서 #을 제외한 ID 값을 가져옵니다.
        const targetId = (link as HTMLAnchorElement).getAttribute('href')?.substring(1);
        if (!targetId) return;

        // 해당 ID를 가진 요소를 찾습니다.
        const targetElement = document.getElementById(targetId);

        // 요소가 존재하면, 해당 위치로 부드럽게 스크롤합니다.
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  });
</script> 