---
// src/components/Adsense.astro
export interface Props {
  slot: string; // 광고 단위 슬롯 ID
  format?: string; // 광고 형식 (선택 사항)
}
const { slot, format = 'auto' } = Astro.props;

const isProd = import.meta.env.PROD;
const adClient = import.meta.env.PUBLIC_ADSENSE_CLIENT;
---
{isProd && (
  <div class="ad-container" data-slot={slot}>
    <ins class="adsbygoogle"
         style="display:block; width:100%; min-height:250px;"
         data-ad-client={adClient}
         data-ad-slot={slot}
         data-ad-format={format}
         data-full-width-responsive="true"></ins>
    <script define:vars={{slot}}>
      // 광고 미게재(unfilled) 또는 로드 실패 시 외부 래퍼(.ad-wrapper)를 자동 숨김
      const container = document.querySelector(`.ad-container[data-slot="${slot}"]`);
      const ins = container ? container.querySelector('ins.adsbygoogle') : null;
      const wrapper = (ins && ins.closest && ins.closest('.ad-wrapper')) || (ins ? ins.parentElement : null) || container;

      const hideWrapper = () => {
        if (wrapper && wrapper instanceof HTMLElement) {
          wrapper.style.display = 'none';
        }
      };

      const isFilled = () => {
        if (!ins) return false;
        const status = ins.getAttribute('data-ad-status');
        return status === 'filled' || (ins instanceof HTMLElement && ins.offsetHeight > 0) || (!!ins.querySelector && !!ins.querySelector('iframe'));
      };

      // data-ad-status 변화를 관찰해 unfilled면 숨김
      if (ins) {
        const mo = new MutationObserver(() => {
          const status = ins.getAttribute('data-ad-status');
          if (status === 'unfilled') hideWrapper();
          if (status === 'filled') mo.disconnect();
        });
        mo.observe(ins, { attributes: true, attributeFilter: ['data-ad-status'] });
      }

      // adsbygoogle 초기화 시도
      setTimeout(() => {
        try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}
      }, 50);

      // 폴링: 일정 시간 내에 채워지지 않으면 숨김
      let attempts = 0;
      const max = 15; // ~4.5초 (300ms * 15)
      const timer = setInterval(() => {
        attempts++;
        if (isFilled()) { clearInterval(timer); return; }
        if (attempts >= max) { hideWrapper(); clearInterval(timer); }
      }, 300);
    </script>
  </div>
)}
